# V免签通知识别流程说明

## 🔍 问题背景

当支付宝有多条收款通知同时存在时，可能出现以下问题：
1. **重复处理**：同一条收款通知被多次处理
2. **金额混乱**：提取到错误的金额信息
3. **时序混乱**：新旧通知处理顺序不当

## 🛠️ 改进后的识别流程

### 第一步：通知接收
```
onNotificationPosted() 被调用
↓
获取通知基本信息（包名、标题、内容、时间）
```

### 第二步：去重检查
```
创建通知唯一标识符：
ID = 包名 + 标题 + 内容
Hash = ID的哈希值

检查是否已处理：
if (已处理过此Hash) {
    跳过处理
    return
}
```

### 第三步：时间间隔检查
```
检查距离上次处理的时间：
if (当前时间 - 上次处理时间 < 2秒) {
    跳过处理（防止短时间重复）
    return
}
```

### 第四步：正常处理流程
```
添加到已处理列表
↓
记录详细日志（包含时间戳）
↓
进行支付宝/微信识别
↓
提取金额并回调
```

## 📊 日志格式改进

### 新的日志格式
```
✅ 处理新通知 ID: a1b2c3d4
📱 [16:15:44] 通知详情 - 包名: com.eg.android.AlipayGphone
📝 标题: 你已成功收款0.11元（老顾客消费）
📄 内容: 已转入余额开线上店铺，一键转发促下单>>
🔍 发现支付宝相关通知！
🎯 匹配到支付宝收款关键词！
💰 成功提取金额: 0.11元，正在回调服务端...
```

### 重复通知处理
```
⚠️ 跳过重复通知
⚠️ 处理间隔过短，跳过
🔄 清理通知缓存
```

## 🎯 解决的问题

### 1. 重复处理问题
- **原理**：通过哈希值识别相同通知
- **效果**：同一条通知只会被处理一次
- **示例**：连续收到3条相同的"收款0.11元"通知，只处理第一条

### 2. 时序混乱问题
- **原理**：添加2秒的最小处理间隔
- **效果**：避免短时间内的重复处理
- **示例**：1秒内收到多条通知，只处理第一条

### 3. 内存管理问题
- **原理**：限制已处理通知列表大小为100条
- **效果**：避免长时间运行导致的内存泄漏
- **示例**：处理100条通知后自动清理缓存

## 📱 实际使用场景

### 场景1：正常收款
```
时间: 16:15:44
通知: "你已成功收款1.00元"
处理: ✅ 正常处理，提取金额1.00元
```

### 场景2：重复通知
```
时间: 16:15:44
通知: "你已成功收款1.00元"
处理: ✅ 正常处理

时间: 16:15:45  
通知: "你已成功收款1.00元" (相同内容)
处理: ⚠️ 跳过重复通知
```

### 场景3：快速连续收款
```
时间: 16:15:44
通知: "你已成功收款1.00元"
处理: ✅ 正常处理

时间: 16:15:45 (间隔1秒)
通知: "你已成功收款2.00元"
处理: ⚠️ 处理间隔过短，跳过

时间: 16:15:47 (间隔3秒)
通知: "你已成功收款2.00元"
处理: ✅ 正常处理
```

## 🔧 配置参数

### 可调整的参数
```java
// 最小处理间隔（毫秒）
private static final long MIN_PROCESS_INTERVAL = 2000; // 2秒

// 最大缓存通知数量
if (processedNotifications.size() > 100) {
    processedNotifications.clear();
}
```

### 建议设置
- **处理间隔**：2-5秒（根据实际收款频率调整）
- **缓存大小**：50-200条（根据内存情况调整）

## ⚠️ 注意事项

### 可能的副作用
1. **延迟处理**：真正的新收款可能被延迟2秒处理
2. **漏处理**：在极端情况下可能漏掉某些通知

### 建议监控
1. **观察日志**：注意"跳过"类型的日志数量
2. **对比实际**：定期对比实际收款和系统记录
3. **调整参数**：根据使用情况调整时间间隔

## 🎉 预期效果

使用改进后的识别流程：
- ✅ **减少重复处理**：避免同一笔收款被多次回调
- ✅ **提高准确性**：确保每笔收款只被处理一次
- ✅ **更好的日志**：清晰显示处理过程和跳过原因
- ✅ **内存优化**：避免长时间运行的内存问题
