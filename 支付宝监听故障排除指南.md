# 支付宝监听故障排除指南

## 问题描述
微信监听正常，但支付宝无法监听到收款通知。

## 可能原因分析

### 1. 支付宝包名变更
- **旧包名**: `com.eg.android.AlipayGphone`
- **新包名**: `com.alipay.android.app`
- **解决方案**: 已在代码中同时支持两个包名

### 2. 通知权限问题
支付宝可能需要特殊的通知权限设置：

#### 检查步骤：
1. **支付宝通知权限**
   - 打开 设置 → 应用管理 → 支付宝 → 通知管理
   - 确保"允许通知"已开启
   - 确保"收款到账语音提醒"相关通知已开启

2. **V免签监听权限**
   - 打开 设置 → 辅助功能 → V免签监控端
   - 确保"通知使用权"已开启

3. **系统通知权限**
   - 设置 → 通知和状态栏 → 通知管理
   - 确保支付宝和V免签都有通知权限

### 3. 支付宝版本兼容性
不同版本的支付宝通知内容可能不同：

#### 支持的通知内容关键词：
- "通过扫码向你付款"
- "成功收款"
- "收钱码收款"
- "向你付款"
- "转账"
- "收款成功"
- "到账"

### 4. 手机系统兼容性
某些手机系统可能限制后台应用监听通知：

#### 解决方案：
1. **添加到白名单**
   - 将V免签和支付宝添加到电池优化白名单
   - 允许后台运行

2. **关闭省电模式**
   - 关闭手机的省电模式或超级省电模式

3. **自启动权限**
   - 允许V免签自启动

## 调试步骤

### 第一步：使用调试功能
1. 重新编译安装修改后的APK
2. 打开V免签，点击"支付宝调试"按钮
3. 查看支付宝安装情况和包名信息

### 第二步：查看日志
1. 连接手机到电脑，启用USB调试
2. 使用ADB查看日志：
   ```bash
   adb logcat | grep "NeNotificationService2"
   ```
3. 进行一笔支付宝收款测试
4. 观察日志中是否有支付宝相关的通知信息

### 第三步：测试收款
1. 确保支付宝收款功能正常
2. 让朋友扫码付款（小额测试）
3. 观察手机通知栏是否有收款通知
4. 查看V免签是否收到回调

## 常见问题解决

### Q1: 日志中看不到支付宝通知
**解决方案**:
- 检查支付宝通知权限
- 确认支付宝版本是否过新或过旧
- 尝试重新安装支付宝

### Q2: 看到支付宝通知但未匹配关键词
**解决方案**:
- 查看日志中的实际通知内容
- 根据实际内容添加新的关键词匹配

### Q3: 匹配到通知但无法提取金额
**解决方案**:
- 检查getMoney方法的正则表达式
- 确认通知内容中金额格式

## 代码修改说明

### 主要改进：
1. **支持多包名**: 同时支持新旧支付宝包名
2. **扩展关键词**: 增加更多收款通知关键词匹配
3. **增强日志**: 专门记录支付宝相关通知便于调试
4. **调试工具**: 添加支付宝检测功能

### 修改的文件：
- `NeNotificationService2.java`: 核心监听逻辑
- `MainActivity.java`: 添加调试方法
- `activity_main.xml`: 添加调试按钮

## 建议的测试流程

1. **安装修改版APK**
2. **检查权限设置**
3. **使用调试功能检测支付宝**
4. **查看ADB日志**
5. **进行小额收款测试**
6. **根据日志调整代码**

## 联系支持
如果按照以上步骤仍无法解决问题，请提供：
1. 手机型号和系统版本
2. 支付宝版本号
3. ADB日志截图
4. 支付宝通知截图
